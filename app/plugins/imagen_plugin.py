# app/plugins/imagen_plugin.py

import logging
import os
import json
from typing import Dict, Any, List

import vertexai
from vertexai.preview.vision_models import ImageGenerationModel

from .base import ToolPlugin

logger = logging.getLogger(__name__)

# --- Custom Exception ---
class ImagenGenerationError(Exception):
    """Custom exception for errors during Imagen asset generation."""
    pass

# --- Plugin Definition ---
class ImagenGenerator(ToolPlugin):
    """
    A plugin that generates images using Google's Imagen model via Vertex AI.
    Creates high-quality images from text descriptions.
    """

    def __init__(self):
        super().__init__()
        
        # Get project settings from environment
        project_id = os.getenv("VERTEX_PROJECT_ID")
        location = os.getenv("VERTEX_LOCATION", "us-central1")
        
        if not project_id:
            raise ValueError("VERTEX_PROJECT_ID environment variable not found or not set.")
        
        # Initialize Vertex AI
        vertexai.init(project=project_id, location=location)
        
        # Load the Imagen model - using imagegeneration for current model availability
        self.generation_model = ImageGenerationModel.from_pretrained("imagegeneration@006")
        
        logger.info(f"Imagen plugin initialized with project: {project_id}, location: {location}")

    @property
    def name(self) -> str:
        return "Imagen Generator"

    @property
    def description(self) -> str:
        return (
            "Generates high-quality static images from text descriptions using Google's Imagen model. "
            "Perfect for creating backgrounds, illustrations, graphics, logos, or any visual content needed for video composition. "
            "The output is always a PNG file with optional transparency support. "
            "CAN DO: Photorealistic images, artistic illustrations, logos, textures, backgrounds, objects, scenes, abstract art. "
            "CANNOT DO: Video generation (use Veo), animations (use Manim), audio content (use Music/Voiceover plugins). "
            "TECHNICAL SPECS: High-resolution PNG output, supports transparency, optimized for video overlay use."
        )

    def get_input_format(self) -> Dict[str, Any]:
        """Returns the input format specification for the Imagen plugin."""
        return {
            "required_fields": ["task", "unit_id", "output_filename"],
            "optional_fields": {},
            "examples": [
                {
                    "task": "Create a vibrant blue gradient background",
                    "unit_id": "blue_gradient_bg",
                    "output_filename": "background.png"
                },
                {
                    "task": "Generate a modern company logo with geometric shapes",
                    "unit_id": "company_logo_v1", 
                    "output_filename": "logo.png"
                },
                {
                    "task": "Create a sunset landscape for video background",
                    "unit_id": "sunset_background",
                    "output_filename": "landscape.png"
                }
            ]
        }

    def execute_task(self, task_details: Dict, asset_unit_path: str, run_logger: logging.Logger) -> List[str]:
        prompt = task_details["task"]
        output_filename = task_details["output_filename"]
        
        run_logger.info(f"IMAGEN PLUGIN: Starting task for unit '{task_details.get('unit_id')}' - '{prompt[:100]}...'.")

        try:
            # Generate image using Imagen via Vertex AI
            run_logger.info("IMAGEN PLUGIN: Calling Vertex AI Imagen model...")
            
            response = self.generation_model.generate_images(
                prompt=prompt,
                number_of_images=1,
                aspect_ratio="1:1",
                negative_prompt="",
                person_generation="allow_all",
                safety_filter_level="block_few",
                add_watermark=True,
            )
            
            if not response.images:
                raise ImagenGenerationError("No images were generated by Imagen model")
            
            # Save the generated image
            output_path = os.path.join(asset_unit_path, output_filename)
            
            run_logger.info(f"IMAGEN PLUGIN: Saving generated image to {output_path}")
            response.images[0].save(output_path)
            
            # Verify the file was created
            if not os.path.exists(output_path):
                raise ImagenGenerationError(f"Generated image file not found at {output_path}")
            
            # Get file size for logging
            file_size = os.path.getsize(output_path)
            run_logger.info(f"IMAGEN PLUGIN: Successfully generated image ({file_size} bytes)")
            
            # Create metadata
            plugin_data = {
                "prompt": prompt,
                "model": "imagen-4.0-generate-preview-06-06",
                "file_size_bytes": file_size,
                "aspect_ratio": "1:1",
                "safety_filter": "block_few"
            }
            
            self._create_metadata_file(
                task_details, 
                asset_unit_path, 
                [output_filename], 
                plugin_data
            )
            
            run_logger.info(f"IMAGEN PLUGIN: Task completed successfully. Generated: {output_filename}")
            return [output_filename]
            
        except Exception as e:
            run_logger.error(f"IMAGEN PLUGIN: Generation failed: {e}", exc_info=True)
            raise ImagenGenerationError(f"Imagen generation failed: {e}") from e
